if(typeof window==="undefined"){window=global}function ATest(a,b){assertMatch(a,String,b,Function);this.name=a;this.fn=b;this._status="queue";this.stack=null;this.details=null;this.error=false;this._id=++ATest._idCnt}ATest._idCnt=0;ATest.prototype.getStatus=function(){return this._status};ATest.prototype.setStatus=function(a){assert("|queue|skip|running...|waiting|pass|fail|".indexOf(a)!=-1,a);this._status=a;console.log(SJTest.LOGTAG+":"+this._status,this.name,this.details||this.stack||"")};ATest.prototype.run=function(f,e){var d=window.reportError;try{window.reportError=function(h){throw h};this.setStatus("running...");console.log(SJTest.LOGTAG,this.name,this.getStatus());this.details=this.fn(this);var g=this;if(!f){if(this._status==="waiting"){f=function(){return g._status==="pass"||g._status==="fail"}}else{this.setStatus("pass");return}}var c=function(h){if(g._status!=="fail"){g.setStatus("pass")}if(h!==true){g.details=h}assert(match(SJTest._displayTest,Function));if(SJTest._displayTable){SJTest._displayTest(g)}};var b=function(){g.error=new Error("Timeout");g.setStatus("fail");assert(match(SJTest._displayTest,Function));if(SJTest._displayTable){SJTest._displayTest(g)}};SJTest.waitFor(f,c,e||10000,b)}catch(a){this.error=a;if(a&&a.stack){this.stack=a.stack}this.setStatus("fail")}finally{window.reportError=d}};ATest.prototype.toString=function(){return"ATest["+this.name+" "+this.getStatus()+"]"};var SJTest=SJTest||{};SJTest.version="0.3.5";SJTest.wait=SJTest.wait||false;if(SJTest.styling===undefined){SJTest.styling=true}SJTest.LOGTAG="SJTest";if(SJTest.on===undefined){var locn=""+window.location;var queryParser=/[?&]SJTest=([^&]+)?/;var m=locn.match(queryParser);if(m&&m[1]&&m[1]!=="false"&&m[1]!=="off"){SJTest.on=true}else{SJTest.on=false}}if(SJTest.expose===undefined){SJTest.expose=true}if(SJTest.minTime===undefined){SJTest.minTime=100}if(SJTest.skip===undefined){SJTest.skip=[]}if(SJTest.only===undefined){SJTest.only=[]}SJTest.tests=[];SJTest.run=function(c){if(!SJTest.on){console.log(SJTest.LOGTAG,"NO run",c);return}console.log(SJTest.LOGTAG,"run",c);assert(typeof c==="object",c);var d=c.name||false;for(var a in c){if(a=="name"){continue}var b=c[a];var e=d?d+"."+a:a;SJTest.runTest(e,b)}};SJTest._started=new Date().getTime();SJTest.isDone=function(){assert(!SJTest.phantomjsTopLevel);if(SJTest.wait){return false}if(new Date().getTime()<SJTest._started+SJTest.minTime){return false}for(var a=0;a<SJTest.tests.length;a++){var b=SJTest.tests[a];if(b.getStatus()!=="pass"&&b.getStatus()!=="fail"&&b.getStatus()!=="skip"){return false}}return true};SJTest.runTest=function(a,g,f,e){if(!SJTest.on){console.log(SJTest.LOGTAG,"NO runTest",a);return}assertMatch(a,String,g,"?Function",f,"?Function",e,"?Number");console.log(SJTest.LOGTAG,"runTest",a);var c=false;if(g){c=new ATest(a,g);c.waitForThis=f;c.timeout=e}else{for(var b=0;b<SJTest.tests.length;b++){var h=SJTest.tests[b];if(h.name===a){c=h;f=c.waitForThis;e=c.timeout;break}}if(!c){c=new ATest(a,function(){throw"Could not find test: "+a})}}var d=false;if(g){if(a.indexOf("//")!=-1){d=true}if(SJTest.skip){if(SJTest.skip.indexOf(a)!=-1){d=true}}if(SJTest.only){for(var b=0;b<SJTest.only.length;b++){}}}SJTest.tests.push(c);if(!d){c.run(f,e)}else{c.setStatus("skip")}if(SJTest._displayTable){SJTest._displayTest(c)}};SJTest.display=function(){if(!SJTest.on){return}var c=0,b=SJTest.tests.length;for(var a=0;a<SJTest.tests.length;a++){var d=SJTest.tests[a];if(d.getStatus()==="pass"){c++}}SJTest._displayPanel=SJTestUtils.$getById("SJTestDisplay");if(!SJTest._displayPanel||!SJTest._displayPanel.length){SJTest._displayPanel=SJTestUtils.$create("<div id='SJTestDisplay' "+(SJTest.styling?"style='z-index:100000;background:white;border:2px solid black;position:fixed;top:0px;right:0px;width:70%;overflow:auto;max-height:100%;'":"")+" class='SJTest panel panel-default'></div>");SJTestUtils.$(document.body).append(SJTest._displayPanel)}else{SJTest._displayPanel.html("")}SJTest._displayPanel.append("<div class='panel-heading'><h2 class='panel-title'>Test Results: <span id='_SJTestGood'>"+c+"</span> / <span id='_SJTestTotal'>"+b+"</span><button title='Close Tests' type='button' "+(SJTest.styling?"style='float:right;'":"")+" class='close' aria-hidden='true' onclick=\"$('#SJTestDisplay').remove();\">&times;</button></h2></div>");SJTest._displayTable=SJTestUtils.$create("<table class='table table-bordered'></table>");SJTest._displayTable.append("<tr><th></th><th>Name</th><th>Result</th><th>Details / Stack</th></tr>");SJTest._displayPanel.append(SJTest._displayTable);for(var a=0;a<SJTest.tests.length;a++){var d=SJTest.tests[a];SJTest._displayTest(d)}};SJTest._displayTest=function(g){assertMatch(g,ATest);var f="tr_SJTest_"+g._id;var e=SJTestUtils.$getById(f);if(!e||!e.length){e=SJTestUtils.$create("<tr id='"+f+"'></tr>");assert(e);SJTest._displayTable.append(e)}if(SJTest.styling){var a=g.getStatus()==="pass"?"#9f9":g.getStatus()==="skip"?"#ccf":g.getStatus()==="running..."||g.getStatus()==="waiting"?"#ff9":"#f99";e.css({border:"1px solid #333","background-color":a})}e.html("<td><a href='#' title='Re-run this test' onclick='SJTest.runTest(\""+g.name+"\"); return false;'>&#8635;</a></td><td>"+g.name+"</td><td>"+g.getStatus()+"</td><td>"+(g.error||SJTestUtils.str(g.details)||"-")+" "+(g.stack||"")+"</td>");var d=0,c=SJTest.tests.length;for(var b=0;b<SJTest.tests.length;b++){var g=SJTest.tests[b];if(g.getStatus()==="pass"){d++}}SJTestUtils.$getById("_SJTestGood").html(""+d);SJTestUtils.$getById("_SJTestTotal").html(""+c)};SJTest.assert=function(a,b){if(a){if(a.jquery&&a.length===0){if(!b){b="empty jquery selection"}SJTest.assertFailed(b);return}return a}SJTest.assertFailed(b||a)};SJTest.assertFailed=function(b){console.error("assert",b);var a=SJTestUtils.str(b);throw new Error("assert-failed: "+a)};SJTest.assertMatch=function(){SJTest.assert(arguments.length%2==0,arguments);for(var c=0;c<arguments.length;c+=2){var b=arguments[c];var a=arguments[c+1];SJTest.assert(SJTest.match(b,a),(arguments.length>2?((c/2)+1)+") ":"")+SJTestUtils.str(b)+" !~ "+a)}};SJTest.isa=function(c,a){if(c===a){return true}if(c instanceof a){return true}for(var b=0;b<10;b++){if(c===null||c===undefined){return false}if(!c.constructor){return false}if(c.constructor==a){return true}c=c.prototype}return false};SJTest.match=function(n,b){if(n==b){return true}var a=""+n;if(typeof b==="string"){if(b[0]==="?"&&(n===null||n===undefined)){return true}if(n===null||n===undefined){return false}var l=b.split("|");for(var t=0;t<l.length;t++){var h=l[t].match(/^\??(\w+?)!?$/);if(!h){break}var o=h[1];if(a===o){return true}if(o==="Number"||o==="number"){if(typeof n==="number"&&!isNaN(n)){return true}var u=parseFloat(n);if(u||u===0){return true}continue}try{var d=new Function("return "+o);var f=d();if(SJTest.isa(n,f)){return true}}catch(c){var g=n;while(true){if(g.constructor&&g.constructor.name===o){return true}g=Object.getPrototypeOf(g);if(!g){break}}}}return false}if(b===false&&!n){return true}if(b===true&&n){return true}if(b instanceof RegExp){try{var e=b.test(a);if(e){return true}}catch(s){}}var q=null;if(b===Number){if(typeof n==="number"&&!isNaN(n)){return true}var u=parseFloat(n);return(u||u===0)}if(typeof b==="function"){if(b.constructor){if(SJTest.isa(n,b)){return true}else{return false}}else{try{q=b();if(n==q){return true}}catch(s){}}}if(typeof n==="function"){try{var r=n();if(r==b){return true}if(q&&r==q){return true}}catch(s){}}if(typeof b==="object"&&typeof n==="object"){for(var j in b){var i=b[j];var k=n[j];if(i!=k){return false}}return true}return false};SJTest.removeValue=function(b,c){var a=c.indexOf(b);if(a==-1){return c}c.splice(a,1);return c};SJTest._scriptsInProcessing=[];SJTest.runScript=function(a,b){if(!SJTest.on){return}console.log(SJTest.LOGTAG,"runScript",a);SJTest._scriptsInProcessing.push(a);SJTestUtils.load(a,function(){SJTest.removeValue(a,SJTest._scriptsInProcessing);if(b){b()}},function(c){SJTest.runTest("runScript",function(){console.error(SJTest.LOGTAG,a,c);throw"Could not load "+a+". See console for details."})})};SJTest.runScriptFromUrl=function(){var b=""+window.location;var d=/[?&]SJTest=([^&]+)?/;var a=b.match(d);if(!a){return}var c=a[1];if(!c){return}if(!SJTest.on){console.log(SJTest.LOGTAG,"NOT on, so not running script "+c);return}console.log(SJTest.LOGTAG,"runScriptFromUrl: "+c);if(c.indexOf("//")!=-1){console.warn(SJTest.LOGTAG,"NOT running. For security, you cannot run cross-domain test scripts.");return}SJTest.runScript(c)};SJTest.waitFor=function(e,d,b,c){SJTest.assertMatch(e,Function,d,"?Function",b,"?Number",c,"?Function");var a=window.jQuery?new jQuery.Deferred():null;SJTest.waitFor.waitingFor.push([e,d,b?new Date().getTime()+b:false,c,a]);SJTest.waitFor.check();return a};SJTest.waitFor.waitingFor=[];SJTest.waitFor.period=50;SJTest.waitFor.check=function(){var b=[];for(var c=0;c<SJTest.waitFor.waitingFor.length;c++){var f=SJTest.waitFor.waitingFor[c];var a=false;try{a=f[0]()}catch(d){}if(a){if(f[1]){f[1](a)}if(f[4]){f[4].resolve()}continue}if(f[2]&&new Date().getTime()>f[2]){console.log("waitFor timeout "+f[0]);if(f[3]){f[3]()}if(f[4]){f[4].reject()}continue}b.push(SJTest.waitFor.waitingFor[c])}SJTest.waitFor.waitingFor=b;if(b.length>0){setTimeout(SJTest.waitFor.check,SJTest.waitFor.period)}};SJTest.expectTests=function(b,a){if(!SJTest.on){return}assert(!SJTest._expectTests,"Already expecting "+SJTest._expectTests+" "+b);SJTest._expectTests=b;if(!a){a=10000}SJTest.runTest("expectTests_"+b,function(){},function(){return SJTest.tests.length>b},a)};var SJTestUtils={_initFlag:false};SJTestUtils.init=function(){if(SJTestUtils._initFlag){return}SJTestUtils._initFlag=true;if(window.$===undefined){}if(!window.console){window.console={};window.console.log=function(){};window.console.error=function(){}}SJTestUtils.load=function(b,f,e){console.log(SJTest.LOGTAG,"loading...",b,f);if(window.$&&$.getScript){console.log(SJTest.LOGTAG,"load by jQuery...",b,f);var a=$.getScript(b,f);if(e){a.fail(e)}return}var d=document.getElementsByTagName("head")[0];var c=document.createElement("script");c.type="text/javascript";c.src=b;c.onload=f;d.appendChild(c)};SJTestUtils.onLoad=window.$;if(!SJTestUtils.onLoad){SJTestUtils.onLoad=function(a){setTimeout(a,10)}}SJTestUtils.str=function(f){if(typeof(printer)!=="undefined"&&printer.str){return printer.str(f)}try{var g=JSON.stringify(f);return g}catch(c){if(f instanceof Array){var d=[];for(var b=0;b<f.length;b++){d[b]=SJTestUtils.str(f[b])}return JSON.stringify(d)}var d={};for(var e in f){var a=f[e];if(typeof(a)=="function"){continue}else{d[e]=""+a}}return JSON.stringify(d)}};SJTestUtils.$=function(b){if(!b){return b}if(window.$){return $(b)}var a={"$el":b};a.append=function(c){assert(c);return SJTestUtils.$append(b,c)};a.html=function(c){if(c!==undefined){b.innerHTML=c}return b.innerHTML};a.length=1;a.css=function(){};return a};SJTestUtils.$getById=function(a){if(window.$){return $("#"+a)}assert(a);return SJTestUtils.$(document.getElementById(a))};SJTestUtils.$create=function(b){if(window.$){return $(b)}assert(b);var c=document.createElement("div");c.innerHTML=b;var a=c.childNodes&&c.childNodes[0]?c.childNodes[0]:c;assert(a,c);return SJTestUtils.$(a)};SJTestUtils.$append=function(a,b){if(window.$){return $(a).append(b)}assert(a);assert(b);if(typeof b==="string"){b=SJTestUtils.$create(b);assert(b)}if(b.$el){b=b.$el}assert(b);console.log("$append",a,b);a.appendChild(b)};if(SJTest.expose){if(!window.assert){window.assert=SJTest.assert}if(!window.match){window.match=SJTest.match}if(!window.waitFor){window.waitFor=SJTest.waitFor}if(!window.assertMatch){window.assertMatch=SJTest.assertMatch}if(!window.isa){window.isa=SJTest.isa}if(!window.str){window.str=SJTestUtils.str}}};if(typeof(navigator)!=="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().indexOf("phantomjs")!=-1){if(!window.location.hostname&&(!window.location.pathname||window.location.pathname.length<2||window.location.pathname.substr(-"SJTest.js".length)==="SJTest.js")){SJTest.phantomjsTopLevel=true}else{SJTest.display=function(){};SJTest._displayTest=function(){}}}SJTestUtils.init();if(typeof(module)!=="undefined"){module.exports=SJTest};