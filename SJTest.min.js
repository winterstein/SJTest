function ATest(a,b){this.name=a;this.fn=b;this._status="queue";this.stack=null;this.details=null;this.error=false;this._id=++ATest._idCnt}ATest._idCnt=0;Object.defineProperty(ATest.prototype,"status",{get:function(){return this._status},set:function(a){this._status=a;console.log(SJTest.LOGTAG+":"+this.status,this.name,this.details||this.stack||"")}});ATest.prototype.run=function(f,e){var d=window.reportError;try{window.reportError=function(h){throw h};this.status="running...";console.log(SJTest.LOGTAG,this.name,this.status);this.details=this.fn();if(!f){this.status="pass";return}var g=this;var c=function(h){console.log("ATest.this",g);g.status="pass";if(h!==true){g.details=h}assert(match(SJTest._displayTest,Function));if(SJTest._displayTable){SJTest._displayTest(g)}};var b=function(){console.log("TIMEOUT ATest.this",g);g.error=new Error("Timeout");g.status="fail";assert(match(SJTest._displayTest,Function));if(SJTest._displayTable){SJTest._displayTest(g)}};SJTest.waitFor(f,c,e||5000,b)}catch(a){this.error=a;if(a&&a.stack){this.stack=a.stack}this.status="fail"}finally{window.reportError=d}};ATest.prototype.toString=function(){return"ATest["+this.name+" "+this.status+"]"};var SJTest={};SJTest.wait=false;SJTest.styling=true;SJTest.LOGTAG="SJTest";SJTest.on=false;SJTest.expose=true;SJTest.on=(""+window.location).match(/SJTest=(1|true|on)/)?true:false;console.log("location",""+window.location+" on? "+SJTest.on);SJTest.skip=[];SJTest.only=[];SJTest.tests=[];SJTest.run=function(c){console.log("SJTest.run");assert(typeof c==="object",c);var d=c.name||false;for(var a in c){if(a=="name"){continue}var b=c[a];var e=d?d+"."+a:a;SJTest.runTest(e,b)}};SJTest.minTime=100;SJTest._started=new Date().getTime();SJTest.isDone=function(){console.log("isDone?");assert(!SJTest.phantomjsTopLevel);if(SJTest.wait){return false}if(new Date().getTime()<SJTest._started+SJTest.minTime){console.log("Wait!");return false}for(var a=0;a<SJTest.tests.length;a++){var b=SJTest.tests[a];if(b.status==="running..."){return false}}console.log("isDone! ",SJTest.tests.length);return true};SJTest.runTest=function(a,g,f,e){console.log("SJTest.runTest",a);if(!SJTest.on){console.log("SJTest.runTest"+a+" NOT!");return}var c=false;if(g){c=new ATest(a,g)}else{for(var b=0;b<SJTest.tests.length;b++){var h=SJTest.tests[b];if(h.name===a){c=h;break}}if(!c){c=new ATest(a,function(){throw"Could not find test: "+a})}}var d=false;if(g){if(a.indexOf("//")!=-1){d=true}if(SJTest.skip){if(SJTest.skip.indexOf(a)!=-1){d=true}}if(SJTest.only){for(var b=0;b<SJTest.only.length;b++){}}}SJTest.tests.push(c);SJTest.current=c;if(!d){c.run(f,e)}else{c.status="skip"}if(c.status=="pass"){}else{}if(SJTest._displayTable){SJTest._displayTest(c)}SJTest.current=null};SJTest.display=function(){if(!SJTest.on){console.log(SJTest.LOGTAG,"Not on = no display");return}console.log(SJTest.LOGTAG,"Display!");var c=0,b=SJTest.tests.length;for(var a=0;a<SJTest.tests.length;a++){var d=SJTest.tests[a];if(d.status==="pass"){c++}}SJTest._displayPanel=SJTestUtils.$getById("SJTestDisplay");if(!SJTest._displayPanel||!SJTest._displayPanel.length){SJTest._displayPanel=SJTestUtils.$create("<div id='SJTestDisplay' "+(SJTest.styling?"style='position:fixed;top:0px;right:0px;width:70%;overflow:auto;max-height:100%;'":"")+" class='SJTest panel panel-default'></div>");SJTestUtils.$(document.body).append(SJTest._displayPanel)}else{SJTest._displayPanel.html("")}SJTest._displayPanel.append("<div class='panel-heading'><h2 class='panel-title'>Test Results: <span id='_SJTestGood'>"+c+"</span> / <span id='_SJTestTotal'>"+b+"</span><button title='Close Tests' type='button' "+(SJTest.styling?"style='float:right;'":"")+" class='close' aria-hidden='true' onclick=\"$('#SJTestDisplay').remove();\">&times;</button></h2></div>");SJTest._displayTable=SJTestUtils.$create("<table class='table table-bordered'></table>");SJTest._displayTable.append("<tr><th></th><th>Name</th><th>Result</th><th>Details</th><th>Stack</th></tr>");SJTest._displayPanel.append(SJTest._displayTable);for(var a=0;a<SJTest.tests.length;a++){var d=SJTest.tests[a];SJTest._displayTest(d)}};SJTest._displayTest=function(g){assertArgs(g,ATest);var f="tr_SJTest_"+g._id;var e=SJTestUtils.$getById(f);if(!e||!e.length){e=SJTestUtils.$create("<tr id='"+f+"'></tr>");assert(e);SJTest._displayTable.append(e)}if(SJTest.styling){var a=g.status=="pass"?"#9f9":g.status=="skip"?"#ccf":g.status=="running..."?"#fff":"#f99";e.css({border:"1px solid #333","background-color":a})}e.html("<td><a href='#' title='Re-run this test' onclick='SJTest.runTest(\""+g.name+"\"); return false;'>&#8635;</a></td><td>"+g.name+"</td><td>"+g.status+"</td><td>"+(g.error||SJTestUtils.str(g.details)||"-")+"</td><td>"+(g.stack||"-")+"</td>");var d=0,c=SJTest.tests.length;for(var b=0;b<SJTest.tests.length;b++){var g=SJTest.tests[b];if(g.status==="pass"){d++}}SJTestUtils.$getById("_SJTestGood").html(""+d);SJTestUtils.$getById("_SJTestTotal").html(""+c)};SJTest.assert=function(a,c){if(a){return}console.error("assert",c||a);var b=SJTestUtils.str(c);throw new Error(b)};SJTest.assertArgs=function(){assert(arguments.length%2==0,arguments);for(var c=0;c<arguments.length;c+=2){var b=arguments[c];var a=arguments[c+1];if(!SJTest.match(b,a)){SJTest.match(b,a);console.error("Bad arguments",arguments);throw new Error("argument "+((c/2)+1)+") "+b+" != "+a)}}};SJTest.assertMatch=function(a,b){assert(match(a,b),a+" !~ "+b)};SJTest.isa=function(c,a){if(c==a){return true}if(c instanceof a){return true}assert(a.constructor);for(var b=0;b<10;b++){if(c===null||c===undefined){return false}if(!c.constructor){return false}if(c.constructor==a){return true}c=c.prototype}return false};SJTest.match=function(o,f){if(o==f){return true}var q=""+o;if(typeof f==="string"){if(f[0]==="?"&&(o===null||o===undefined)){return true}var a=f.split("|");for(var g=0;g<a.length;g++){var d=a[g].match(/^\??(\w+?)!?$/);if(!d){break}try{var k=new Function("return "+d);var h=k();if(SJTest.isa(o,h)){return true}else{return false}}catch(e){}}return false}if(!f&&!o){return true}if(f===true&&o){return true}if(f instanceof RegExp){try{var c=f.test(q);if(c){return true}}catch(j){}}var l=null;if(f===Number){if(!o&&o!==0){return false}}if(typeof f==="function"){if(f.constructor){if(SJTest.isa(o,f)){return true}else{return false}}else{try{l=f();if(o==l){return true}}catch(j){}}}if(typeof o==="function"){try{var i=o();if(i==f){return true}if(l&&i==l){return true}}catch(j){}}if(typeof f==="object"&&typeof o==="object"){for(var b in f){var r=f[b];var n=o[b];if(r!=n){return false}}return true}return false};if(!window.match){window.match=SJTest.match}SJTest._scriptsInProcessing=[];SJTest.runScript=function(a,b){if(!SJTest.on){return}console.log("runScript",a);SJTest._scriptsInProcessing.push(a);SJTestUtils.load(a,function(){console.log("runScript Done",a);SJTest._scriptsInProcessing.removeValue(a);if(b){b()}},function(){SJTest.runTest("runScript",function(){throw"Could not load "+a+". See console for details."})})};SJTest.waitFor=function(d,c,a,b){SJTest.assertArgs(d,Function,c,Function);SJTest.waitFor.waitingFor.push([d,c,a?new Date().getTime()+a:false,b]);SJTest.waitFor.check()};SJTest.waitFor.waitingFor=[];SJTest.waitFor.period=50;SJTest.waitFor.check=function(){var b=[];for(var c=0;c<SJTest.waitFor.waitingFor.length;c++){var f=SJTest.waitFor.waitingFor[c];var a=false;try{a=f[0]()}catch(d){}if(a){f[1](a);continue}if(f[2]&&new Date().getTime()>f[2]){console.log("waitFor timeout "+f[0]);if(f[3]){f[3]()}continue}b.push(SJTest.waitFor.waitingFor[c])}SJTest.waitFor.waitingFor=b;if(b.length>0){setTimeout(SJTest.waitFor.check,SJTest.waitFor.period)}};SJTest.expectTests=function(b,a){assert(!SJTest._expectTests,"Already expecting "+SJTest._expectTests+" "+b);SJTest._expectTests=b;if(!a){a=10000}SJTest.runTest("expectTests_"+b,function(){},function(){return SJTest.tests.length>b},a)};var SJTestUtils={_initFlag:false};SJTestUtils.init=function(){if(SJTestUtils._initFlag){return}SJTestUtils._initFlag=true;if(!Array.prototype.removeValue){Array.prototype.removeValue=function(b){var a=this.indexOf(b);if(a!=-1){Array.prototype.splice.call(this,a,true)}return this}}if(window.$===undefined){}if(!window.console){window.console={};window.console.log=function(){}}SJTestUtils.load=function(b,f,e){console.log(SJTest.LOGTAG,"loading...",b);if(window.$&&$.getScript){var a=$.getScript(b,f);if(e){a.fail(e)}return}var d=document.getElementsByTagName("head")[0];var c=document.createElement("script");c.type="text/javascript";c.src=b;c.onload=f;d.appendChild(c)};SJTestUtils.onLoad=window.$;if(!SJTestUtils.onLoad){SJTestUtils.onLoad=function(a){setTimeout(a,10)}}if(window.printer&&printer.str){SJTestUtils.str=printer.str}else{SJTestUtils.str=function(f){try{var g=JSON.stringify(f);return g}catch(c){if(f instanceof Array){var d=[];for(var b=0;b<f.length;b++){d[b]=SJTestUtils.str(f[b])}return JSON.stringify(d)}var d={};for(var e in f){var a=f[e];if(typeof(a)=="function"){continue}else{d[e]=""+a}}return JSON.stringify(d)}}}SJTestUtils.$=function(b){if(!b){return b}if(window.$){return $(b)}var a={"$el":b};a.append=function(c){assert(c);console.log("append",b,c);return SJTestUtils.$append(b,c)};a.html=function(c){if(c!==undefined){b.innerHTML=c}return b.innerHTML};a.length=1;a.css=function(){};return a};SJTestUtils.$getById=function(a){if(window.$){return $("#"+a)}assert(a);return SJTestUtils.$(document.getElementById(a))};SJTestUtils.$create=function(b){if(window.$){return $(b)}assert(b);console.log("$create",b);var c=document.createElement("div");c.innerHTML=b;var a=c.childNodes&&c.childNodes[0]?c.childNodes[0]:c;assert(a,c);return SJTestUtils.$(a)};SJTestUtils.$append=function(a,b){if(window.$){return $(a).append(b)}assert(a);assert(b);if(typeof b==="string"){b=SJTestUtils.$create(b);assert(b)}if(b.$el){b=b.$el}assert(b);console.log("$append",a,b);a.appendChild(b)};if(SJTest.expose){if(!window.assert){window.assert=SJTest.assert}if(!window.match){window.match=SJTest.match}if(!window.assertArgs){window.assertArgs=SJTest.assertArgs}if(!window.assertMatch){window.assertMatch=SJTest.assertMatch}if(!window.isa){window.isa=SJTest.isa}if(!window.str){window.str=SJTestUtils.str}}};if(navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().indexOf("phantomjs")!=-1){if(!window.location.hostname&&(!window.location.pathname||window.location.pathname.length<2||window.location.pathname.substr(-"SJTest.js".length)==="SJTest.js")){SJTest.phantomjsTopLevel=true}else{SJTest.display=function(){};SJTest._displayTest=function(){}}}SJTestUtils.init();var SJTest4Phantom={};SJTest4Phantom._doThemAll=function(){var b=SJTest4Phantom._pagesToLoad.pop();var a=function(){SJTest4Phantom._doThemAll()};assert(b);assert(SJTest.phantomjsTopLevel,SJTest);var c=require("webpage").create();c.onConsoleMessage=function(e){console.log(e);var d=e.substr(0,"SJTest:pass".length);if(d==="SJTest:pass"){SJTest4Phantom.passed.push(e)}else{if(d==="SJTest:fail"){SJTest4Phantom.failed.push(e)}else{if(d==="SJTest:skip"){SJTest4Phantom.skipped.push(e)}}}};if(b.indexOf("?")!=-1){b+="&SJTest=1"}else{b+="?SJTest=1"}c.open(b,a);SJTest4Phantom._pagesInProcessing.push(c);console.log("PhantomJS opened: "+b+"...")};SJTest4Phantom.passed=[];SJTest4Phantom.failed=[];SJTest4Phantom.skipped=[];SJTest4Phantom.goPhantom=function(){var b=require("system").args;if(b[0].substr(-"SJTest.js".length)==="SJTest.js"){SJTest.on=true}else{console.warn("SJTest OFF: Did not recognise script "+b[0])}if(b.length===1){console.log("SJTest version 0.1 by Daniel Winterstein");console.log("Usage: phantomjs SJTest.js MyTestFile1.html MyTestFile2.html ...");phantom.exit();return}for(var c=1;c<b.length;c++){var a=b[c];console.log("PhantomJS queuing: "+a+"...");SJTest4Phantom._pagesToLoad.push(a)}console.log("GO");SJTest4Phantom._doThemAll();SJTest.waitFor(SJTest4Phantom.isDoneTopLevel,function(){var g=SJTest4Phantom.passed.length,e=SJTest4Phantom.failed.length,d=SJTest4Phantom.skipped.length;console.log("");console.log(SJTest.LOGTAG,"Passed: "+SJTest4Phantom.passed);console.log(SJTest.LOGTAG,"Failed: "+SJTest4Phantom.failed);console.log("");console.log(SJTest.LOGTAG,"Tests: "+(g+d+e)+"\tPassed: "+g+"\tSkipped: "+d+"\tFailed: "+e);if(e==0){console.log(SJTest.LOGTAG,":)")}else{console.log(SJTest.LOGTAG,":(")}phantom.exit()})};SJTest4Phantom.isDoneTopLevel=function(){console.log("isDoneTopLevel?");assert(SJTest.phantomjsTopLevel);for(var b=0;b<SJTest4Phantom._pagesInProcessing.length;b++){var d=SJTest4Phantom._pagesInProcessing[b];var a=d.evaluate(function(){return SJTest.isDone()});console.log(SJTest.phantomjsTopLevel+" "+d.url+" done "+a);if(a){console.log("Remove page!",d);SJTest4Phantom._pagesInProcessing.removeValue(d);try{d.close()}catch(c){}}}if(SJTest4Phantom._pagesToLoad.length>0||SJTest4Phantom._pagesInProcessing.length>0){console.log("Q",SJTest4Phantom._pagesToLoad,"Pages",SJTest4Phantom._pagesInProcessing);return false}console.log("DoneTopLevel!");return true};SJTest4Phantom._pagesToLoad=[];SJTest4Phantom._pagesInProcessing=[];if(!SJTest.phantomjsTopLevel){SJTestUtils.onLoad(function(){setTimeout(SJTest.display,1)})}else{SJTest4Phantom.goPhantom()};